<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Транспорт</title>
    <link rel="stylesheet" href="css/style.css">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <script src="js/api.js"></script>
</head>
<body>

<h1>Транспорт</h1>

<table id="vehicles-table">
    <thead>
    <tr>
        <th>ID</th>
        <th>Название</th>
        <th>Модель</th>
        <th>Номера</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<h2 style="margin-top:40px;">Карта</h2>
<div id="map" style="height: 400px; margin-top:20px;"></div>

<script>
    let map = L.map('map').setView([55.75, 37.61], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let marker = null;

    async function loadVehicles() {
        const vehicles = await apiGet("/vehicles");
        const tbody = document.querySelector("#vehicles-table tbody");
        tbody.innerHTML = "";

        vehicles.forEach(v => {
            const row = document.createElement("tr");

            const lastPing = v.lastPing ? `${v.lastPing.lat}, ${v.lastPing.lon}` : "—";

            row.innerHTML = `
            <td>${v.id}</td>
            <td>${v.manufacturer}</td>
            <td>${v.model}</td>
            <td>${v.registrationPlate}</td>
            <td>
                <button onclick="sendPing(${v.id})">Отправить пинг</button>
                <button onclick="showOnMap(${v.id})">К карте</button>
            </td>
        `;
            tbody.appendChild(row);
        });
    }

    async function sendPing(id) {
        const lat = parseFloat(prompt("Введите широту:"));
        const lon = parseFloat(prompt("Введите долготу:"));

        await fetch("/aks-lab-1/api/v1/pings", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ vehicleId: id, lat, lon })
        });

        alert("Пинг отправлен!");
        loadVehicles();
    }

    async function showOnMap(vehicleId) {
        const last = await apiGet(`/pings/vehicle/${vehicleId}/last`);

        if (!last.lat) {
            alert("У машины ещё нет пингов");
            return;
        }

        if (marker) map.removeLayer(marker);

        marker = L.marker([last.lat, last.lon]).addTo(map)
            .bindPopup(`Машина ${vehicleId}`).openPopup();

        map.setView([last.lat, last.lon], 14);
    }

    loadVehicles();
    setInterval(loadVehicles, 5000);
</script>

</body>
</html>
