databaseChangeLog:
  - changeSet:
      id: 0001-init-schema
      author: Ekaterina
      changes:
        # GEO_ZONE
        - createTable:
            tableName: geo_zone
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_geo_zone
              - column:
                  name: name
                  type: VARCHAR(128)
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uq_geo_zone_name
              - column:
                  name: latitude
                  type: DOUBLE PRECISION
                  constraints:
                    nullable: false
              - column:
                  name: longitude
                  type: DOUBLE PRECISION
                  constraints:
                    nullable: false
              - column:
                  name: radius_meters
                  type: DOUBLE PRECISION
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
        - createIndex:
            tableName: geo_zone
            indexName: idx_zone_name
            columns:
              - column:
                  name: name
        - createIndex:
            tableName: geo_zone
            indexName: idx_zone_lat_lon
            columns:
              - column: { name: latitude }
              - column: { name: longitude }

        # VEHICLE
        - createTable:
            tableName: vehicle
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_vehicle
              - column:
                  name: registration_plate
                  type: VARCHAR(32)
                  constraints:
                    nullable: false
                    unique: true
                    uniqueConstraintName: uq_vehicle_plate
              - column:
                  name: model
                  type: VARCHAR(128)
              - column:
                  name: manufacturer
                  type: VARCHAR(128)
              - column:
                  name: created_at
                  type: TIMESTAMP
        - createIndex:
            tableName: vehicle
            indexName: idx_vehicle_plate
            columns:
              - column: { name: registration_plate }

        # JOB_ORDER
        - createTable:
            tableName: job_order
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_job_order
              - column:
                  name: vehicle_id
                  type: BIGINT
                  constraints:
                    nullable: true
              - column:
                  name: status
                  type: VARCHAR(16)
                  constraints:
                    nullable: false
              - column:
                  name: planned_zone_id
                  type: BIGINT
              - column:
                  name: started_at
                  type: TIMESTAMP
              - column:
                  name: completed_at
                  type: TIMESTAMP
              - column:
                  name: created_at
                  type: TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: job_order
            baseColumnNames: vehicle_id
            constraintName: fk_order_vehicle
            referencedTableName: vehicle
            referencedColumnNames: id
            onDelete: RESTRICT
        - addForeignKeyConstraint:
            baseTableName: job_order
            baseColumnNames: planned_zone_id
            constraintName: fk_order_planned_zone
            referencedTableName: geo_zone
            referencedColumnNames: id
            onDelete: SET NULL
        - createIndex:
            tableName: job_order
            indexName: idx_order_vehicle
            columns:
              - column: { name: vehicle_id }
        - createIndex:
            tableName: job_order
            indexName: idx_order_status
            columns:
              - column: { name: status }

        # TRACKER_PING
        - createTable:
            tableName: tracker_ping
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_tracker_ping
              - column:
                  name: vehicle_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: timestamp
                  type: TIMESTAMP
                  constraints:
                    nullable: false
              - column:
                  name: latitude
                  type: DOUBLE PRECISION
                  constraints:
                    nullable: false
              - column:
                  name: longitude
                  type: DOUBLE PRECISION
                  constraints:
                    nullable: false
              - column:
                  name: speed_kmh
                  type: DOUBLE PRECISION
              - column:
                  name: heading_deg
                  type: DOUBLE PRECISION
              - column:
                  name: created_at
                  type: TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: tracker_ping
            baseColumnNames: vehicle_id
            constraintName: fk_ping_vehicle
            referencedTableName: vehicle
            referencedColumnNames: id
            onDelete: RESTRICT
        - createIndex:
            tableName: tracker_ping
            indexName: idx_ping_vehicle_time
            columns:
              - column: { name: vehicle_id }
              - column: { name: timestamp }
        - createIndex:
            tableName: tracker_ping
            indexName: idx_ping_lat_lon
            columns:
              - column: { name: latitude }
              - column: { name: longitude }

        # ZONE_VISIT
        - createTable:
            tableName: zone_visit
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_zone_visit
              - column:
                  name: vehicle_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: zone_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: job_order_id
                  type: BIGINT
              - column:
                  name: entered_at
                  type: TIMESTAMP
              - column:
                  name: left_at
                  type: TIMESTAMP
              - column:
                  name: confirmed
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: TIMESTAMP
        - addForeignKeyConstraint:
            baseTableName: zone_visit
            baseColumnNames: vehicle_id
            constraintName: fk_visit_vehicle
            referencedTableName: vehicle
            referencedColumnNames: id
            onDelete: RESTRICT
        - addForeignKeyConstraint:
            baseTableName: zone_visit
            baseColumnNames: zone_id
            constraintName: fk_visit_zone
            referencedTableName: geo_zone
            referencedColumnNames: id
            onDelete: RESTRICT
        - addForeignKeyConstraint:
            baseTableName: zone_visit
            baseColumnNames: job_order_id
            constraintName: fk_visit_order
            referencedTableName: job_order
            referencedColumnNames: id
            onDelete: SET NULL
        - createIndex:
            tableName: zone_visit
            indexName: idx_visit_vehicle_zone
            columns:
              - column: { name: vehicle_id }
              - column: { name: zone_id }
        - createIndex:
            tableName: zone_visit
            indexName: idx_visit_order
            columns:
              - column: { name: job_order_id }

      rollback:
        - dropTable: { tableName: zone_visit }
        - dropTable: { tableName: tracker_ping }
        - dropTable: { tableName: job_order }
        - dropTable: { tableName: vehicle }
        - dropTable: { tableName: geo_zone }
